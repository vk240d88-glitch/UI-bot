# main_window.py - –ü–û–õ–ù–´–ô –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ö–û–î
import sys
import random
import threading
import time
import traceback
from datetime import datetime
from typing import Dict
from PyQt5.QtWidgets import (QMainWindow, QWidget, QVBoxLayout, QHBoxLayout, 
                             QLabel, QPushButton, QFrame, QTabWidget, QStatusBar,
                             QGraphicsDropShadowEffect, QListWidget, QListWidgetItem,
                             QCheckBox, QComboBox, QSlider, QScrollArea, QGroupBox,
                             QTextEdit, QProgressBar, QTableWidget, QTableWidgetItem,
                             QHeaderView, QSplitter, QMessageBox, QTreeWidget, QTreeWidgetItem,
                             QGridLayout, QSpinBox, QDoubleSpinBox, QDialog, QDialogButtonBox,
                             QFormLayout, QLineEdit)
from PyQt5.QtCore import Qt, QTimer, QDateTime, pyqtSignal, QThread
from PyQt5.QtGui import QFont, QColor, QTextCursor

from dashboard import DashboardWidget
from settings import SettingsWidget

class FilterAnalysisWidget(QTableWidget):
    """–í–∏–¥–∂–µ—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –æ—Ç–∫–∞–∑–∞/–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å–¥–µ–ª–æ–∫"""
    
    def __init__(self):
        super().__init__()
        self.setColumnCount(9)  # –°–∏–º–≤–æ–ª + 7 —Ñ–∏–ª—å—Ç—Ä–æ–≤ + –∏—Ç–æ–≥
        self.setHorizontalHeaderLabels([
            "–°–∏–º–≤–æ–ª", "–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å", "–¢—Ä–µ–Ω–¥", "ADX", "RSI", 
            "–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å", "–í–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å", "–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ", "–†–ï–®–ï–ù–ò–ï"
        ])
        
        self.setStyleSheet("""
            QTableWidget {
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 12px;
                gridline-color: rgba(255, 255, 255, 0.1);
                color: #FFFFFF;
                font-size: 13px;
                font-weight: 500;
            }
            QTableWidget::item {
                padding: 10px 6px;
                border-bottom: 1px solid rgba(255, 255, 255, 0.08);
                height: 22px;
            }
            QHeaderView::section {
                background: rgba(0, 212, 170, 0.25);
                color: #00D4AA;
                font-weight: 700;
                font-size: 12px;
                padding: 10px 6px;
                border: none;
            }
        """)
        
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞–∑–º–µ—Ä–æ–≤ –∫–æ–ª–æ–Ω–æ–∫
        self.horizontalHeader().setSectionResizeMode(0, QHeaderView.ResizeToContents)
        for i in range(1, 8):
            self.horizontalHeader().setSectionResizeMode(i, QHeaderView.ResizeToContents)
        self.horizontalHeader().setSectionResizeMode(8, QHeaderView.Stretch)
        
        self.setEditTriggers(QTableWidget.NoEditTriggers)
        self.setRowCount(0)
    
    def update_filter_analysis(self, symbol: str, technical_data: Dict, primary_trend: Dict, 
                             entry_signal: Dict, decision: Dict):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–Ω–∞–ª–∏–∑–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –¥–ª—è —Å–∏–º–≤–æ–ª–∞"""
        
        # –ò—â–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å—Ç—Ä–æ–∫—É
        row_count = self.rowCount()
        row_index = -1
        for i in range(row_count):
            if self.item(i, 0).text() == symbol:
                row_index = i
                break
        
        # –ï—Å–ª–∏ –Ω–µ—Ç - –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É
        if row_index == -1:
            row_index = row_count
            self.insertRow(row_index)
        
        # –î–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–æ–∫
        confidence = entry_signal.get('confidence', 0)
        trend_confidence = primary_trend.get('confidence', 0)
        adx = technical_data['trend'].get('adx', 0)
        rsi = entry_signal.get('rsi', 50)
        trend = primary_trend.get('trend', 'NEUTRAL')
        action = entry_signal.get('action', 'HOLD')
        volatility = technical_data['risk'].get('volatility', 'LOW')
        execution_conf = technical_data['execution'].get('confidence', 0)
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤
        filters_passed = []
        
        # 1. –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å —Å–∏–≥–Ω–∞–ª–∞ (>= 0.65)
        conf_ok = confidence >= 0.65
        filters_passed.append(conf_ok)
        
        # 2. –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å —Ç—Ä–µ–Ω–¥–∞ (>= 0.6)
        trend_ok = trend_confidence >= 0.6
        filters_passed.append(trend_ok)
        
        # 3. ADX (>= 20)
        adx_ok = adx >= 20
        filters_passed.append(adx_ok)
        
        # 4. RSI (25-75)
        rsi_ok = 25 <= rsi <= 75
        filters_passed.append(rsi_ok)
        
        # 5. –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å
        consistency_ok = ((trend == 'BULLISH' and action == 'BUY') or 
                         (trend == 'BEARISH' and action == 'SELL'))
        filters_passed.append(consistency_ok)
        
        # 6. –í–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å
        volatility_ok = not (volatility == 'HIGH' and confidence < 0.75)
        filters_passed.append(volatility_ok)
        
        # 7. –ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ
        execution_ok = execution_conf >= 0.4
        filters_passed.append(execution_ok)
        
        # –ò—Ç–æ–≥–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ
        all_passed = all(filters_passed)
        final_decision = decision.get('action', 'HOLD')
        
        # –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–∞–±–ª–∏—Ü—É
        self.fill_filter_row(row_index, symbol, filters_passed, final_decision,
                           confidence, trend_confidence, adx, rsi, 
                           consistency_ok, volatility, execution_conf)
    
    def fill_filter_row(self, row_index, symbol, filters_passed, final_decision,
                       confidence, trend_conf, adx, rsi, consistency_ok, volatility, execution_conf):
        """–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤"""
        
        # –°–∏–º–≤–æ–ª
        symbol_item = QTableWidgetItem(symbol)
        symbol_item.setFont(QFont("Segoe UI", 12, QFont.Bold))
        
        # –§–∏–ª—å—Ç—Ä—ã —Å –∏–∫–æ–Ω–∫–∞–º–∏
        items = []
        
        # 1. –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å
        conf_item = QTableWidgetItem(f"{confidence:.2f}")
        conf_item.setFont(QFont("Segoe UI", 11, QFont.Bold))
        conf_item.setForeground(QColor('#00D4AA') if filters_passed[0] else QColor('#FF6B6B'))
        items.append(conf_item)
        
        # 2. –¢—Ä–µ–Ω–¥
        trend_item = QTableWidgetItem(f"{trend_conf:.2f}")
        trend_item.setFont(QFont("Segoe UI", 11, QFont.Bold))
        trend_item.setForeground(QColor('#00D4AA') if filters_passed[1] else QColor('#FF6B6B'))
        items.append(trend_item)
        
        # 3. ADX
        adx_item = QTableWidgetItem(f"{adx:.1f}")
        adx_item.setFont(QFont("Segoe UI", 11, QFont.Bold))
        adx_item.setForeground(QColor('#00D4AA') if filters_passed[2] else QColor('#FF6B6B'))
        items.append(adx_item)
        
        # 4. RSI
        rsi_item = QTableWidgetItem(f"{rsi:.1f}")
        rsi_item.setFont(QFont("Segoe UI", 11, QFont.Bold))
        rsi_item.setForeground(QColor('#00D4AA') if filters_passed[3] else QColor('#FF6B6B'))
        items.append(rsi_item)
        
        # 5. –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å
        consistency_item = QTableWidgetItem("‚úÖ" if filters_passed[4] else "‚ùå")
        consistency_item.setFont(QFont("Segoe UI", 12))
        consistency_item.setForeground(QColor('#00D4AA') if filters_passed[4] else QColor('#FF6B6B'))
        items.append(consistency_item)
        
        # 6. –í–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å
        vol_item = QTableWidgetItem(volatility)
        vol_item.setFont(QFont("Segoe UI", 11))
        vol_item.setForeground(QColor('#00D4AA') if filters_passed[5] else QColor('#FF6B6B'))
        items.append(vol_item)
        
        # 7. –ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ
        exec_item = QTableWidgetItem(f"{execution_conf:.2f}")
        exec_item.setFont(QFont("Segoe UI", 11, QFont.Bold))
        exec_item.setForeground(QColor('#00D4AA') if filters_passed[6] else QColor('#FF6B6B'))
        items.append(exec_item)
        
        # 8. –ò—Ç–æ–≥–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ
        decision_item = QTableWidgetItem(final_decision)
        decision_item.setFont(QFont("Segoe UI", 12, QFont.Bold))
        if final_decision == 'EXECUTED':
            decision_item.setForeground(QColor('#00D4AA'))
            decision_item.setText("‚úÖ EXECUTED")
        elif final_decision == 'HOLD':
            decision_item.setForeground(QColor('#FFA726'))
        else:
            decision_item.setForeground(QColor('#FF6B6B'))
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ items
        self.setItem(row_index, 0, symbol_item)
        for i, item in enumerate(items, 1):
            self.setItem(row_index, i, item)
        self.setItem(row_index, 8, decision_item)

class AnalysisVisualizer(QTreeWidget):
    """–í–∏–¥–∂–µ—Ç –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∞–Ω–∞–ª–∏–∑–∞"""
    
    def __init__(self):
        super().__init__()
        self.setColumnCount(3)
        self.setHeaderLabels(["–≠—Ç–∞–ø –∞–Ω–∞–ª–∏–∑–∞", "–°—Ç–∞—Ç—É—Å", "–î–µ—Ç–∞–ª–∏"])
        
        self.setStyleSheet("""
            QTreeWidget {
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 12px;
                color: #FFFFFF;
                font-size: 16px;
                font-weight: 500;
            }
            QTreeWidget::item {
                padding: 12px 8px;
                border-bottom: 1px solid rgba(255, 255, 255, 0.08);
                height: 25px;
            }
            QHeaderView::section {
                background: rgba(86, 171, 255, 0.25);
                color: #56ABFF;
                font-weight: 700;
                font-size: 15px;
                padding: 12px 8px;
                border: none;
            }
        """)
        
        self.setColumnWidth(0, 250)
        self.setColumnWidth(1, 120)
        self.setColumnWidth(2, 400)
    
    def add_analysis_step(self, symbol, step_name, status, details=""):
        """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —à–∞–≥–∞ –∞–Ω–∞–ª–∏–∑–∞"""
        symbol_item = None
        for i in range(self.topLevelItemCount()):
            item = self.topLevelItem(i)
            if item.text(0) == symbol:
                symbol_item = item
                break
        
        if not symbol_item:
            symbol_item = QTreeWidgetItem([symbol, "üîç –ê–Ω–∞–ª–∏–∑...", ""])
            symbol_item.setFont(0, QFont("Segoe UI", 14, QFont.Bold))
            self.addTopLevelItem(symbol_item)
            symbol_item.setExpanded(True)
        
        step_item = QTreeWidgetItem([step_name, status, details])
        step_item.setFont(0, QFont("Segoe UI", 13))
        step_item.setFont(1, QFont("Segoe UI", 13))
        step_item.setFont(2, QFont("Segoe UI", 12))
        symbol_item.addChild(step_item)
        
        self.scrollToItem(step_item)
        
        if "‚úÖ" in status:
            symbol_item.setText(1, "‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω")
            symbol_item.setForeground(1, QColor('#00D4AA'))
        elif "‚ùå" in status:
            symbol_item.setText(1, "‚ùå –û—à–∏–±–∫–∞")
            symbol_item.setForeground(1, QColor('#FF6B6B'))
        elif "‚ö°" in status:
            symbol_item.setText(1, "‚ö° –í –ø—Ä–æ—Ü–µ—Å—Å–µ")
            symbol_item.setForeground(1, QColor('#FFA726'))

class TradingLogWidget(QTextEdit):
    """–í–∏–¥–∂–µ—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ª–æ–≥–æ–≤ —Ç–æ—Ä–≥–æ–≤–ª–∏"""
    
    def __init__(self):
        super().__init__()
        self.setReadOnly(True)
        self.setMaximumHeight(250)
        self.setStyleSheet("""
            QTextEdit {
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 12px;
                color: #B0B0B0;
                font-family: 'Segoe UI', sans-serif;
                font-size: 15px;
                font-weight: 500;
                padding: 12px;
                line-height: 1.4;
            }
        """)
    
    def add_log(self, message, message_type="info"):
        """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –ª–æ–≥"""
        timestamp = QDateTime.currentDateTime().toString("hh:mm:ss")
        
        if message_type == "error":
            color = "#FF6B6B"
            prefix = "‚ùå"
        elif message_type == "success":
            color = "#00D4AA"
            prefix = "‚úÖ"
        elif message_type == "warning":
            color = "#FFA726"
            prefix = "‚ö†Ô∏è"
        else:
            color = "#56ABFF"
            prefix = "‚ÑπÔ∏è"
        
        html_message = f"""
        <div style="margin: 4px 0; line-height: 1.4;">
            <span style="color: #B0B0B0; font-size: 14px;">[{timestamp}]</span>
            <span style="color: {color}; font-weight: 600; font-size: 15px;"> {prefix} {message}</span>
        </div>
        """
        
        scrollbar = self.verticalScrollBar()
        at_bottom = scrollbar.value() == scrollbar.maximum()
        
        self.append(html_message)
        
        if at_bottom:
            cursor = self.textCursor()
            cursor.movePosition(QTextCursor.End)
            self.setTextCursor(cursor)

class PositionsWidget(QTableWidget):
    """–í–∏–¥–∂–µ—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π"""
    
    def __init__(self):
        super().__init__()
        self.setColumnCount(6)
        self.setHorizontalHeaderLabels(["–°–∏–º–≤–æ–ª", "–°—Ç–æ—Ä–æ–Ω–∞", "–†–∞–∑–º–µ—Ä", "–¶–µ–Ω–∞ –≤—Ö–æ–¥–∞", "P&L", "P&L %"])
        
        self.setStyleSheet("""
            QTableWidget {
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 12px;
                gridline-color: rgba(255, 255, 255, 0.1);
                color: #FFFFFF;
                font-size: 14px;
                font-weight: 500;
            }
            QTableWidget::item {
                padding: 12px 8px;
                border-bottom: 1px solid rgba(255, 255, 255, 0.08);
                height: 25px;
            }
            QHeaderView::section {
                background: rgba(86, 171, 255, 0.25);
                color: #56ABFF;
                font-weight: 700;
                font-size: 14px;
                padding: 12px 8px;
                border: none;
            }
        """)
        
        self.horizontalHeader().setSectionResizeMode(QHeaderView.Stretch)
        self.setSelectionBehavior(QTableWidget.SelectRows)
        self.setEditTriggers(QTableWidget.NoEditTriggers)
        self.setRowCount(0)

    def update_positions(self, positions):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–æ–∑–∏—Ü–∏–π"""
        self.setRowCount(len(positions))
        
        for row, position in enumerate(positions):
            symbol_item = QTableWidgetItem(position.get('symbol', 'N/A'))
            symbol_item.setFont(QFont("Segoe UI", 13))
            
            side = position.get('side', '').upper()
            side_item = QTableWidgetItem(side)
            side_item.setFont(QFont("Segoe UI", 13, QFont.Bold))
            if side == 'LONG':
                side_item.setForeground(QColor('#00D4AA'))
            else:
                side_item.setForeground(QColor('#FF6B6B'))
            
            size = position.get('size', 0)
            size_item = QTableWidgetItem(f"{size:.4f}")
            size_item.setFont(QFont("Segoe UI", 13))
            
            entry_price = position.get('entry_price', 0)
            entry_item = QTableWidgetItem(f"{entry_price:.4f}")
            entry_item.setFont(QFont("Segoe UI", 13))
            
            pnl = position.get('unrealized_pnl', 0)
            pnl_item = QTableWidgetItem(f"{pnl:.2f} USDT")
            pnl_item.setFont(QFont("Segoe UI", 13, QFont.Bold))
            if pnl >= 0:
                pnl_item.setForeground(QColor('#00D4AA'))
            else:
                pnl_item.setForeground(QColor('#FF6B6B'))
            
            if entry_price > 0 and size > 0:
                pnl_percent = (pnl / (entry_price * size)) * 100
                percent_item = QTableWidgetItem(f"{pnl_percent:.2f}%")
                percent_item.setFont(QFont("Segoe UI", 13, QFont.Bold))
                if pnl_percent >= 0:
                    percent_item.setForeground(QColor('#00D4AA'))
                else:
                    percent_item.setForeground(QColor('#FF6B6B'))
            else:
                percent_item = QTableWidgetItem("0.00%")
                percent_item.setFont(QFont("Segoe UI", 13))
            
            self.setItem(row, 0, symbol_item)
            self.setItem(row, 1, side_item)
            self.setItem(row, 2, size_item)
            self.setItem(row, 3, entry_item)
            self.setItem(row, 4, pnl_item)
            self.setItem(row, 5, percent_item)

class GrokAnalysisWidget(QWidget):
    """–í–∏–¥–∂–µ—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞ Grok —Å –£–ú–ï–ù–¨–®–ï–ù–ù–´–ú —à—Ä–∏—Ñ—Ç–æ–º"""
    
    def __init__(self):
        super().__init__()
        self.layout = QVBoxLayout(self)
        self.layout.setContentsMargins(10, 10, 10, 10)
        self.layout.setSpacing(10)
        
        self.title = QLabel("üéØ –ê–ù–ê–õ–ò–ó GROK AI")
        self.title.setStyleSheet("""
            color: #56ABFF; 
            font-size: 18px;
            font-weight: 700;
            padding: 5px 0px;
        """)
        self.title.setAlignment(Qt.AlignCenter)
        
        self.analysis_table = QTableWidget()
        self.analysis_table.setColumnCount(4)
        self.analysis_table.setHorizontalHeaderLabels(["–°–∏–º–≤–æ–ª", "–¢—Ä–µ–Ω–¥", "–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å", "–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ"])
        
        self.analysis_table.setStyleSheet("""
            QTableWidget {
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 12px;
                color: #FFFFFF;
                font-size: 13px;
                font-weight: 500;
            }
            QTableWidget::item {
                padding: 10px 6px;
                border-bottom: 1px solid rgba(255, 255, 255, 0.08);
                height: 22px;
            }
            QHeaderView::section {
                background: rgba(86, 171, 255, 0.25);
                color: #56ABFF;
                font-weight: 700;
                font-size: 13px;
                padding: 10px 6px;
                border: none;
            }
        """)
        
        self.analysis_table.horizontalHeader().setSectionResizeMode(0, QHeaderView.ResizeToContents)
        self.analysis_table.horizontalHeader().setSectionResizeMode(1, QHeaderView.ResizeToContents)
        self.analysis_table.horizontalHeader().setSectionResizeMode(2, QHeaderView.ResizeToContents)
        self.analysis_table.horizontalHeader().setSectionResizeMode(3, QHeaderView.Stretch)
        self.analysis_table.setEditTriggers(QTableWidget.NoEditTriggers)
        
        self.layout.addWidget(self.title)
        self.layout.addWidget(self.analysis_table)
    
    def update_analysis(self, symbol, analysis_data):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–Ω–∞–ª–∏–∑–∞ –¥–ª—è —Å–∏–º–≤–æ–ª–∞"""
        row_count = self.analysis_table.rowCount()
        row_index = -1
        for i in range(row_count):
            if self.analysis_table.item(i, 0).text() == symbol:
                row_index = i
                break
        
        if row_index == -1:
            row_index = row_count
            self.analysis_table.insertRow(row_index)
        
        trend = analysis_data.get('trend', 'NEUTRAL')
        confidence = analysis_data.get('confidence', 0) * 100
        reasoning = analysis_data.get('reasoning', '')
        
        symbol_item = QTableWidgetItem(symbol)
        symbol_item.setFont(QFont("Segoe UI", 12, QFont.Bold))
        
        trend_item = QTableWidgetItem(trend)
        trend_item.setFont(QFont("Segoe UI", 12, QFont.Bold))
        if trend == 'BULLISH':
            trend_item.setForeground(QColor('#00D4AA'))
        elif trend == 'BEARISH':
            trend_item.setForeground(QColor('#FF6B6B'))
        else:
            trend_item.setForeground(QColor('#FFA726'))
        
        confidence_item = QTableWidgetItem(f"{confidence:.1f}%")
        confidence_item.setFont(QFont("Segoe UI", 12, QFont.Bold))
        if confidence >= 70:
            confidence_item.setForeground(QColor('#00D4AA'))
        elif confidence >= 50:
            confidence_item.setForeground(QColor('#FFA726'))
        else:
            confidence_item.setForeground(QColor('#FF6B6B'))
        
        reasoning_item = QTableWidgetItem(reasoning)
        reasoning_item.setFont(QFont("Segoe UI", 11))
        reasoning_item.setToolTip(reasoning)
        
        self.analysis_table.setItem(row_index, 0, symbol_item)
        self.analysis_table.setItem(row_index, 1, trend_item)
        self.analysis_table.setItem(row_index, 2, confidence_item)
        self.analysis_table.setItem(row_index, 3, reasoning_item)

class TechnicalAnalysisWidget(QWidget):
    """–í–∏–¥–∂–µ—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏"""
    
    def __init__(self):
        super().__init__()
        self.layout = QVBoxLayout(self)
        self.layout.setContentsMargins(10, 10, 10, 10)
        self.layout.setSpacing(10)
        
        self.title = QLabel("üìä –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ô –ê–ù–ê–õ–ò–ó –ò –§–ò–õ–¨–¢–†–ê–¶–ò–Ø")
        self.title.setStyleSheet("""
            color: #00D4AA; 
            font-size: 18px;
            font-weight: 700;
            padding: 5px 0px;
        """)
        self.title.setAlignment(Qt.AlignCenter)
        
        self.analysis_table = QTableWidget()
        self.analysis_table.setColumnCount(6)
        self.analysis_table.setHorizontalHeaderLabels(["–°–∏–º–≤–æ–ª", "–¢–µ—Ö. —Å–∏–≥–Ω–∞–ª", "–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å", "Grok —Ç—Ä–µ–Ω–¥", "–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å", "–†–µ—à–µ–Ω–∏–µ"])
        self.analysis_table.setStyleSheet("""
            QTableWidget {
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 12px;
                color: #FFFFFF;
                font-size: 13px;
                font-weight: 500;
            }
            QTableWidget::item {
                padding: 12px 6px;
                border-bottom: 1px solid rgba(255, 255, 255, 0.08);
                height: 25px;
            }
            QHeaderView::section {
                background: rgba(0, 212, 170, 0.25);
                color: #00D4AA;
                font-weight: 700;
                font-size: 13px;
                padding: 12px 6px;
                border: none;
            }
        """)
        
        self.analysis_table.horizontalHeader().setSectionResizeMode(0, QHeaderView.ResizeToContents)
        self.analysis_table.horizontalHeader().setSectionResizeMode(1, QHeaderView.ResizeToContents)
        self.analysis_table.horizontalHeader().setSectionResizeMode(2, QHeaderView.ResizeToContents)
        self.analysis_table.horizontalHeader().setSectionResizeMode(3, QHeaderView.ResizeToContents)
        self.analysis_table.horizontalHeader().setSectionResizeMode(4, QHeaderView.ResizeToContents)
        self.analysis_table.horizontalHeader().setSectionResizeMode(5, QHeaderView.Stretch)
        
        self.analysis_table.setEditTriggers(QTableWidget.NoEditTriggers)
        
        self.layout.addWidget(self.title)
        self.layout.addWidget(self.analysis_table)
    
    def update_analysis(self, symbol, technical_data, grok_data, decision):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞"""
        row_count = self.analysis_table.rowCount()
        row_index = -1
        for i in range(row_count):
            if self.analysis_table.item(i, 0).text() == symbol:
                row_index = i
                break
        
        if row_index == -1:
            row_index = row_count
            self.analysis_table.insertRow(row_index)
        
        tech_signal = technical_data.get('action', 'HOLD')
        tech_confidence = technical_data.get('confidence', 0) * 100
        grok_trend = grok_data.get('trend', 'NEUTRAL')
        grok_confidence = grok_data.get('confidence', 0) * 100
        
        is_consistent = (grok_trend == 'BULLISH' and tech_signal == 'BUY') or \
                       (grok_trend == 'BEARISH' and tech_signal == 'SELL') or \
                       (grok_trend == 'RANGING' and tech_signal in ['BUY', 'SELL'])
        
        consistency = "‚úÖ –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ" if is_consistent else "‚ùå –ù–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ"
        final_decision = decision.get('action', 'HOLD')
        
        symbol_item = QTableWidgetItem(symbol)
        symbol_item.setFont(QFont("Segoe UI", 13, QFont.Bold))
        
        tech_signal_item = QTableWidgetItem(tech_signal)
        tech_signal_item.setFont(QFont("Segoe UI", 13, QFont.Bold))
        if tech_signal == 'BUY':
            tech_signal_item.setForeground(QColor('#00D4AA'))
        elif tech_signal == 'SELL':
            tech_signal_item.setForeground(QColor('#FF6B6B'))
        else:
            tech_signal_item.setForeground(QColor('#FFA726'))
        
        tech_conf_item = QTableWidgetItem(f"{tech_confidence:.1f}%")
        tech_conf_item.setFont(QFont("Segoe UI", 13))
        
        grok_trend_item = QTableWidgetItem(f"{grok_trend} ({grok_confidence:.1f}%)")
        grok_trend_item.setFont(QFont("Segoe UI", 13))
        if grok_trend == 'BULLISH':
            grok_trend_item.setForeground(QColor('#00D4AA'))
        elif grok_trend == 'BEARISH':
            grok_trend_item.setForeground(QColor('#FF6B6B'))
        else:
            grok_trend_item.setForeground(QColor('#FFA726'))
        
        consistency_item = QTableWidgetItem(consistency)
        consistency_item.setFont(QFont("Segoe UI", 13, QFont.Bold))
        consistency_item.setForeground(QColor('#00D4AA') if is_consistent else QColor('#FF6B6B'))
        
        decision_item = QTableWidgetItem(final_decision)
        decision_item.setFont(QFont("Segoe UI", 13, QFont.Bold))
        if final_decision == 'EXECUTED':
            decision_item.setForeground(QColor('#00D4AA'))
        elif final_decision == 'HOLD':
            decision_item.setForeground(QColor('#FFA726'))
        else:
            decision_item.setForeground(QColor('#FF6B6B'))
        
        self.analysis_table.setItem(row_index, 0, symbol_item)
        self.analysis_table.setItem(row_index, 1, tech_signal_item)
        self.analysis_table.setItem(row_index, 2, tech_conf_item)
        self.analysis_table.setItem(row_index, 3, grok_trend_item)
        self.analysis_table.setItem(row_index, 4, consistency_item)
        self.analysis_table.setItem(row_index, 5, decision_item)

class BotWorker(QThread):
    """–†–∞–±–æ—á–∏–π –ø–æ—Ç–æ–∫ –¥–ª—è —Ç–æ—Ä–≥–æ–≤–æ–≥–æ –±–æ—Ç–∞"""
    
    status_update = pyqtSignal(str)
    trade_signal = pyqtSignal(dict)
    error_signal = pyqtSignal(str)
    account_update = pyqtSignal(dict)
    positions_update = pyqtSignal(list)
    analysis_step = pyqtSignal(str, str, str, str)
    grok_analysis_result = pyqtSignal(str, dict)
    technical_analysis_result = pyqtSignal(str, dict, dict, dict)
    
    def __init__(self):
        super().__init__()
        self.symbols = []
        self.leverage = 5
        self.position_size = 15
        self.is_running = False
        self.trader = None
        self.scheduler = None
        self.initial_grok_analysis = {}
        
    def setup(self, symbols, leverage, position_size):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –±–æ—Ç–∞"""
        self.symbols = symbols
        self.leverage = leverage
        self.position_size = position_size
        
        self.bybit_api_key = "OqFgjGKhzUyTU2Yesq"
        self.bybit_secret = "UazxgpqNbiFCFApiOHAd1f1s57a2GhXc4w7x"
        self.grok_api_key = "xai-p4j0VXesw69krSosEru3vufOu8XQkpYpMU7MBxQi9BGMFn6jq5QmAhjwsmcRD2CcEtfhvG28os6Ld822"
    
    def run(self):
        """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ"""
        try:
            self.is_running = True
            self.status_update.emit("üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–æ—Ä–≥–æ–≤–æ–≥–æ –±–æ—Ç–∞...")
            
            from grok_trading_bot import (
                BybitFuturesTrader, AdvancedTechnicalAnalyzer, GrokTrendFilter,
                SocialSentimentGuard, DynamicPositionManager, SmartTradingPipeline,
                KnowledgeBase, TradingScheduler
            )
            
            self.trader = BybitFuturesTrader(self.bybit_api_key, self.bybit_secret, True)
            technical_analyzer = AdvancedTechnicalAnalyzer()
            grok_filter = GrokTrendFilter(self.grok_api_key)
            social_guard = SocialSentimentGuard()
            position_manager = DynamicPositionManager(self.trader)
            
            self.status_update.emit("üîß –°–æ–∑–¥–∞–Ω–∏–µ —Ç–æ—Ä–≥–æ–≤–æ–≥–æ –ø–∞–π–ø–ª–∞–π–Ω–∞...")
            
            trading_pipeline = SmartTradingPipeline(
                self.trader, technical_analyzer, grok_filter, social_guard, position_manager
            )
            
            knowledge = KnowledgeBase()
            knowledge.load_from_file()
            
            self.status_update.emit("üéØ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ Grok...")
            
            self.initial_grok_analysis = grok_filter.perform_initial_analysis(
                self.symbols, technical_analyzer, self.trader.exchange
            )
            trading_pipeline.set_initial_grok_analysis(self.initial_grok_analysis)
            
            for symbol, analysis in self.initial_grok_analysis.items():
                self.grok_analysis_result.emit(symbol, analysis)
            
            self.status_update.emit("üìä –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞...")
            
            self.scheduler = TradingScheduler(trading_pipeline, self.trader, knowledge)
            self.scheduler.setup(self.symbols, self.leverage, self.position_size)
            self.scheduler.analysis_interval = 2
            
            if not self.scheduler.symbols:
                self.error_signal.emit("‚ùå –ù–µ—Ç —Ä–∞–±–æ—á–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤!")
                return
            
            self.status_update.emit("‚úÖ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω! –ù–∞—á–∏–Ω–∞–µ–º –∞–Ω–∞–ª–∏–∑...")
            
            analysis_count = 0
            while self.is_running:
                try:
                    # –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
                    if not self.is_running:
                        break
                        
                    analysis_count += 1
                    
                    account_info = self.trader.get_account_info()
                    self.account_update.emit(account_info)
                    
                    positions = self.trader.get_positions()
                    self.positions_update.emit(positions)
                    
                    self.status_update.emit(f"üîç –ó–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞ —Ä—ã–Ω–∫–∞ #{analysis_count}...")
                    self.analysis_step.emit("SYSTEM", "–ù–∞—á–∞–ª–æ –∞–Ω–∞–ª–∏–∑–∞", "‚ö°", f"–ê–Ω–∞–ª–∏–∑ #{analysis_count}")
                    
                    self.scheduler.run_market_analysis()
                    
                    self.status_update.emit(f"‚úÖ –ê–Ω–∞–ª–∏–∑ #{analysis_count} –∑–∞–≤–µ—Ä—à–µ–Ω")
                    self.analysis_step.emit("SYSTEM", "–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∞–Ω–∞–ª–∏–∑–∞", "‚úÖ", f"–ê–Ω–∞–ª–∏–∑ #{analysis_count} –∑–∞–≤–µ—Ä—à–µ–Ω")
                    
                    # –ü–∞—É–∑–∞ –º–µ–∂–¥—É –∞–Ω–∞–ª–∏–∑–∞–º–∏ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
                    wait_time = self.scheduler.analysis_interval * 60
                    for i in range(wait_time):
                        if not self.is_running:  # –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
                            break
                        if i % 10 == 0:
                            remaining = wait_time - i
                            self.status_update.emit(f"‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞: {remaining} —Å–µ–∫")
                        time.sleep(1)
                        
                except Exception as e:
                    error_msg = f"–û—à–∏–±–∫–∞ –≤ —Ü–∏–∫–ª–µ –±–æ—Ç–∞: {str(e)}"
                    self.error_signal.emit(error_msg)
                    self.analysis_step.emit("SYSTEM", "–û—à–∏–±–∫–∞", "‚ùå", error_msg)
                    time.sleep(30)
                    
        except Exception as e:
            error_msg = f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –±–æ—Ç–∞: {str(e)}"
            self.error_signal.emit(error_msg)
            self.analysis_step.emit("SYSTEM", "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞", "‚ùå", error_msg)

    def stop(self):
        """–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞"""
        self.is_running = False
        if self.scheduler:
            self.scheduler.stop()
        self.wait(5000)  # –ñ–¥–µ–º –¥–æ 5 —Å–µ–∫—É–Ω–¥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–æ—Ç–æ–∫–∞

class PremiumMainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        self.bot_worker = None
        self.analysis_count = 0  # –î–û–ë–ê–í–õ–ï–ù–û: –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—á–µ—Ç—á–∏–∫–∞
        self.init_ui()
        
    def init_ui(self):
        self.setWindowTitle("üöÄ Crypto Trading Bot - Professional Platform v2.4")
        self.setGeometry(100, 100, 1920, 1080)
        self.setMinimumSize(1600, 900)
        
        central_widget = QWidget()
        self.setCentralWidget(central_widget)
        
        main_layout = QVBoxLayout(central_widget)
        main_layout.setContentsMargins(20, 20, 20, 20)
        main_layout.setSpacing(20)
        
        self.create_premium_header(main_layout)
        self.create_premium_tabs(main_layout)
        self.create_premium_status_bar()
        
        self.ui_timer = QTimer()
        self.ui_timer.timeout.connect(self.update_ui)
        self.ui_timer.start(2000)
        
    def create_premium_header(self, parent_layout):
        header_frame = QFrame()
        header_frame.setObjectName("glass-card")
        header_frame.setMinimumHeight(120)
        
        shadow = QGraphicsDropShadowEffect()
        shadow.setBlurRadius(25)
        shadow.setColor(QColor(0, 0, 0, 60))
        shadow.setOffset(0, 8)
        header_frame.setGraphicsEffect(shadow)
        
        header_layout = QHBoxLayout(header_frame)
        header_layout.setContentsMargins(30, 20, 30, 20)
        
        brand_layout = QVBoxLayout()
        
        self.title_label = QLabel("–ö–†–ò–ü–¢–û –¢–†–ï–ô–î–ò–ù–ì –ë–û–¢ v2.4")
        self.title_label.setObjectName("header-main")
        self.title_label.setFont(QFont("Segoe UI", 28, QFont.Bold))
        
        self.subtitle_label = QLabel("AI-–ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Ç–æ—Ä–≥–æ–≤–ª–∏ ‚Ä¢ –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –±–æ—Ç")
        self.subtitle_label.setObjectName("header-sub")
        self.subtitle_label.setFont(QFont("Segoe UI", 14))
        
        brand_layout.addWidget(self.title_label)
        brand_layout.addWidget(self.subtitle_label)
        
        status_layout = QVBoxLayout()
        status_layout.setAlignment(Qt.AlignCenter)
        
        self.status_indicator = QLabel("üî¥ –°–ò–°–¢–ï–ú–ê –û–°–¢–ê–ù–û–í–õ–ï–ù–ê")
        self.status_indicator.setObjectName("status-offline")
        self.status_indicator.setAlignment(Qt.AlignCenter)
        self.status_indicator.setFont(QFont("Segoe UI", 16, QFont.Bold))
        
        self.bot_status_text = QLabel("–¢–æ—Ä–≥–æ–≤—ã–π –±–æ—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω")
        self.bot_status_text.setStyleSheet("color: #B0B0B0; font-size: 14px; font-weight: 500;")
        self.bot_status_text.setAlignment(Qt.AlignCenter)
        
        status_layout.addWidget(self.status_indicator)
        status_layout.addWidget(self.bot_status_text)
        
        control_layout = QHBoxLayout()
        control_layout.setSpacing(15)
        
        self.start_bot_btn = QPushButton("üöÄ –ó–ê–ü–£–°–ö –ë–û–¢–ê")
        self.start_bot_btn.setObjectName("success")
        self.start_bot_btn.setFixedSize(180, 60)
        self.start_bot_btn.setFont(QFont("Segoe UI", 14, QFont.Bold))
        self.start_bot_btn.clicked.connect(self.start_trading_bot)
        
        self.stop_bot_btn = QPushButton("üõë –°–¢–û–ü –ë–û–¢–ê")
        self.stop_bot_btn.setObjectName("danger")
        self.stop_bot_btn.setFixedSize(160, 60)
        self.stop_bot_btn.setFont(QFont("Segoe UI", 14, QFont.Bold))
        self.stop_bot_btn.clicked.connect(self.stop_trading_bot)
        self.stop_bot_btn.setEnabled(False)
        
        settings_btn = QPushButton("‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò")
        settings_btn.setObjectName("secondary")
        settings_btn.setFixedSize(160, 60)
        settings_btn.setFont(QFont("Segoe UI", 14, QFont.Bold))
        settings_btn.clicked.connect(self.show_settings)
        
        control_layout.addWidget(self.start_bot_btn)
        control_layout.addWidget(self.stop_bot_btn)
        control_layout.addWidget(settings_btn)
        
        header_layout.addLayout(brand_layout)
        header_layout.addStretch()
        header_layout.addLayout(status_layout)
        header_layout.addStretch()
        header_layout.addLayout(control_layout)
        
        parent_layout.addWidget(header_frame)
        
    def create_premium_tabs(self, parent_layout):
        self.tabs = QTabWidget()
        self.tabs.setDocumentMode(True)
        
        self.tabs.setStyleSheet("""
            QTabWidget::pane {
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 12px;
                background: rgba(255, 255, 255, 0.05);
            }
            QTabBar::tab {
                background: rgba(255, 255, 255, 0.05);
                color: #B0B0B0;
                padding: 15px 25px;
                margin-right: 3px;
                border-top-left-radius: 10px;
                border-top-right-radius: 10px;
                font-weight: 600;
                font-size: 14px;
            }
            QTabBar::tab:selected {
                background: rgba(86, 171, 255, 0.25);
                color: #56ABFF;
                border-bottom: 3px solid #56ABFF;
            }
            QTabBar::tab:hover {
                background: rgba(86, 171, 255, 0.15);
            }
        """)
        
        self.dashboard_tab = DashboardWidget()
        self.tabs.addTab(self.dashboard_tab, "üìä –î–ê–®–ë–û–†–î")
        
        self.bot_monitor_tab = self.create_bot_monitor_tab()
        self.tabs.addTab(self.bot_monitor_tab, "ü§ñ –ú–û–ù–ò–¢–û–†–ò–ù–ì")
        
        self.settings_tab = SettingsWidget()
        self.tabs.addTab(self.settings_tab, "‚öôÔ∏è –¢–û–†–ì–û–í–õ–Ø")
        
        parent_layout.addWidget(self.tabs)
        
    def create_bot_monitor_tab(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ –≤–∫–ª–∞–¥–∫–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å —Ç–∞–±–ª–∏—Ü–µ–π —Ñ–∏–ª—å—Ç—Ä–æ–≤"""
        main_widget = QWidget()
        main_layout = QVBoxLayout(main_widget)
        main_layout.setContentsMargins(10, 10, 10, 10)
        main_layout.setSpacing(15)
        
        top_splitter = QSplitter(Qt.Horizontal)
        
        stats_frame = QFrame()
        stats_frame.setObjectName("glass-card")
        stats_layout = QVBoxLayout(stats_frame)
        stats_layout.setContentsMargins(15, 15, 15, 15)
        
        stats_title = QLabel("üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ë–û–¢–ê")
        stats_title.setStyleSheet("""
            color: #56ABFF; 
            font-size: 18px; 
            font-weight: 700;
            padding: 5px 0px;
        """)
        stats_title.setAlignment(Qt.AlignCenter)
        
        self.stats_analysis_label = QLabel("0")
        self.stats_analysis_label.setStyleSheet("color: #FFFFFF; font-size: 24px; font-weight: 700;")
        
        self.stats_trades_label = QLabel("0/5")
        self.stats_trades_label.setStyleSheet("color: #FFFFFF; font-size: 24px; font-weight: 700;")
        
        self.stats_uptime_label = QLabel("00:00:00")
        self.stats_uptime_label.setStyleSheet("color: #FFFFFF; font-size: 24px; font-weight: 700;")
        
        self.stats_success_label = QLabel("0")
        self.stats_success_label.setStyleSheet("color: #FFFFFF; font-size: 24px; font-weight: 700;")
        
        stats_grid = QGridLayout()
        stats_grid.addWidget(QLabel("üîÑ –ê–Ω–∞–ª–∏–∑–æ–≤:"), 0, 0)
        stats_grid.addWidget(self.stats_analysis_label, 0, 1)
        stats_grid.addWidget(QLabel("üìä –°–¥–µ–ª–æ–∫ —Å–µ–≥–æ–¥–Ω—è:"), 1, 0)
        stats_grid.addWidget(self.stats_trades_label, 1, 1)
        stats_grid.addWidget(QLabel("‚è±Ô∏è –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã:"), 2, 0)
        stats_grid.addWidget(self.stats_uptime_label, 2, 1)
        stats_grid.addWidget(QLabel("üéØ –£—Å–ø–µ—à–Ω—ã—Ö —Å–¥–µ–ª–æ–∫:"), 3, 0)
        stats_grid.addWidget(self.stats_success_label, 3, 1)
        
        for i in range(stats_grid.count()):
            widget = stats_grid.itemAt(i).widget()
            if isinstance(widget, QLabel) and widget != self.stats_analysis_label and widget != self.stats_trades_label and widget != self.stats_uptime_label and widget != self.stats_success_label:
                widget.setStyleSheet("color: #B0B0B0; font-size: 16px; font-weight: 600;")
        
        stats_layout.addWidget(stats_title)
        stats_layout.addLayout(stats_grid)
        stats_layout.addStretch()
        
        self.grok_analysis_widget = GrokAnalysisWidget()
        
        top_splitter.addWidget(stats_frame)
        top_splitter.addWidget(self.grok_analysis_widget)
        top_splitter.setSizes([400, 800])
        
        filters_group = QGroupBox("üö¶ –§–ò–õ–¨–¢–†–´ –°–î–ï–õ–û–ö - –°–¶–ï–ù–ê–†–ò–ò –û–¢–ö–ê–ó–ê/–ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø")
        filters_group.setStyleSheet("""
            QGroupBox {
                color: #FFA726;
                font-weight: 700;
                font-size: 16px;
                border: 2px solid rgba(255, 167, 38, 0.3);
                border-radius: 12px;
                margin-top: 10px;
                padding-top: 10px;
            }
            QGroupBox::title {
                subcontrol-origin: margin;
                left: 15px;
                padding: 0 10px 0 10px;
            }
        """)
        filters_layout = QVBoxLayout(filters_group)
        self.filter_analysis_widget = FilterAnalysisWidget()
        filters_layout.addWidget(self.filter_analysis_widget)
        
        self.technical_analysis_widget = TechnicalAnalysisWidget()
        
        bottom_splitter = QSplitter(Qt.Horizontal)
        
        analysis_group = QGroupBox("üîç –ü–†–û–¶–ï–°–° –ê–ù–ê–õ–ò–ó–ê –í –†–ï–ê–õ–¨–ù–û–ú –í–†–ï–ú–ï–ù–ò")
        analysis_group.setStyleSheet("""
            QGroupBox {
                color: #FFA726;
                font-weight: 700;
                font-size: 16px;
                border: 2px solid rgba(255, 167, 38, 0.3);
                border-radius: 12px;
                margin-top: 10px;
                padding-top: 10px;
            }
            QGroupBox::title {
                subcontrol-origin: margin;
                left: 15px;
                padding: 0 10px 0 10px;
            }
        """)
        analysis_layout = QVBoxLayout(analysis_group)
        self.analysis_visualizer = AnalysisVisualizer()
        analysis_layout.addWidget(self.analysis_visualizer)
        
        right_splitter = QSplitter(Qt.Vertical)
        
        positions_group = QGroupBox("üìä –û–¢–ö–†–´–¢–´–ï –ü–û–ó–ò–¶–ò–ò")
        positions_group.setStyleSheet("""
            QGroupBox {
                color: #00D4AA;
                font-weight: 700;
                font-size: 16px;
                border: 2px solid rgba(0, 212, 170, 0.3);
                border-radius: 12px;
                margin-top: 10px;
                padding-top: 10px;
            }
            QGroupBox::title {
                subcontrol-origin: margin;
                left: 15px;
                padding: 0 10px 0 10px;
            }
        """)
        positions_layout = QVBoxLayout(positions_group)
        self.positions_table = PositionsWidget()
        positions_layout.addWidget(self.positions_table)
        
        logs_group = QGroupBox("üìù –õ–û–ì –¢–û–†–ì–û–í–õ–ò")
        logs_group.setStyleSheet("""
            QGroupBox {
                color: #56ABFF;
                font-weight: 700;
                font-size: 16px;
                border: 2px solid rgba(86, 171, 255, 0.3);
                border-radius: 12px;
                margin-top: 10px;
                padding-top: 10px;
            }
            QGroupBox::title {
                subcontrol-origin: margin;
                left: 15px;
                padding: 0 10px 0 10px;
            }
        """)
        logs_layout = QVBoxLayout(logs_group)
        self.trading_log = TradingLogWidget()
        
        log_buttons_layout = QHBoxLayout()
        clear_logs_btn = QPushButton("üßπ –û–ß–ò–°–¢–ò–¢–¨ –õ–û–ì–ò")
        clear_logs_btn.setFixedSize(150, 40)
        clear_logs_btn.setFont(QFont("Segoe UI", 12, QFont.Bold))
        clear_logs_btn.clicked.connect(self.trading_log.clear)
        
        clear_analysis_btn = QPushButton("üßπ –û–ß–ò–°–¢–ò–¢–¨ –ê–ù–ê–õ–ò–ó")
        clear_analysis_btn.setFixedSize(150, 40)
        clear_analysis_btn.setFont(QFont("Segoe UI", 12, QFont.Bold))
        clear_analysis_btn.clicked.connect(self.analysis_visualizer.clear)
        
        log_buttons_layout.addWidget(clear_logs_btn)
        log_buttons_layout.addWidget(clear_analysis_btn)
        log_buttons_layout.addStretch()
        
        logs_layout.addWidget(self.trading_log)
        logs_layout.addLayout(log_buttons_layout)
        
        right_splitter.addWidget(positions_group)
        right_splitter.addWidget(logs_group)
        right_splitter.setSizes([500, 400])
        
        bottom_splitter.addWidget(analysis_group)
        bottom_splitter.addWidget(right_splitter)
        bottom_splitter.setSizes([700, 500])
        
        main_layout.addWidget(top_splitter, 1)
        main_layout.addWidget(filters_group, 1)
        main_layout.addWidget(self.technical_analysis_widget, 1)
        main_layout.addWidget(bottom_splitter, 2)
        
        return main_widget
        
    def create_premium_status_bar(self):
        status_bar = QStatusBar()
        self.setStatusBar(status_bar)
        
        self.system_info = QLabel("ü§ñ AI Trading Bot v2.4 ‚Ä¢ –°—Ç–∞–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è ‚Ä¢ –†—É—Å—Å–∫–∞—è –≤–µ—Ä—Å–∏—è")
        self.system_info.setStyleSheet("color: #B0B0B0; font-weight: 500; font-size: 14px;")
        status_bar.addWidget(self.system_info)
        
        self.update_time_label = QLabel()
        self.update_time_label.setStyleSheet("color: #56ABFF; font-weight: 600; font-size: 14px;")
        status_bar.addPermanentWidget(self.update_time_label)
        
        self.connection_status = QLabel("üîó –ë–∏—Ä–∂–∞: –ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ")
        self.connection_status.setStyleSheet("color: #FF6B6B; font-weight: 600; font-size: 14px;")
        status_bar.addPermanentWidget(self.connection_status)
        
    def start_trading_bot(self):
        """–ó–∞–ø—É—Å–∫ —Ç–æ—Ä–≥–æ–≤–æ–≥–æ –±–æ—Ç–∞"""
        try:
            symbols = self.settings_tab.selected_pairs
            leverage = self.settings_tab.leverage_spin.value()
            position_size = self.settings_tab.position_size_spin.value()
            
            if not symbols:
                QMessageBox.warning(self, "–û—à–∏–±–∫–∞", "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—Ä–≥–æ–≤—ã–µ –ø–∞—Ä—ã –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö!")
                return
            
            self.bot_worker = BotWorker()
            self.bot_worker.setup(symbols, leverage, position_size)
            
            self.bot_worker.status_update.connect(self.on_bot_status_update)
            self.bot_worker.error_signal.connect(self.on_bot_error)
            self.bot_worker.account_update.connect(self.on_account_update)
            self.bot_worker.positions_update.connect(self.on_positions_update)
            self.bot_worker.analysis_step.connect(self.on_analysis_step)
            self.bot_worker.grok_analysis_result.connect(self.on_grok_analysis_result)
            self.bot_worker.technical_analysis_result.connect(self.on_technical_analysis_result)
            
            self.bot_worker.start()
            
            self.start_bot_btn.setEnabled(False)
            self.stop_bot_btn.setEnabled(True)
            self.status_indicator.setText("üü¢ –¢–û–†–ì–û–í–õ–Ø –ê–ö–¢–ò–í–ù–ê")
            self.status_indicator.setObjectName("status-online")
            self.status_indicator.style().unpolish(self.status_indicator)
            self.status_indicator.style().polish(self.status_indicator)
            
            # –î–û–ë–ê–í–õ–ï–ù–û: —Å–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–∞ –∞–Ω–∞–ª–∏–∑–æ–≤
            self.analysis_count = 0
            self.stats_analysis_label.setText("0")
            
            self.dashboard_tab.set_bot_running(True)
            
            self.trading_log.add_log("–¢–æ—Ä–≥–æ–≤—ã–π –±–æ—Ç –∑–∞–ø—É—â–µ–Ω", "success")
            self.trading_log.add_log(f"–°–∏–º–≤–æ–ª—ã: {', '.join(symbols)}", "info")
            self.trading_log.add_log(f"–ü–ª–µ—á–æ: {leverage}x, –†–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏: {position_size}%", "info")
            
        except Exception as e:
            error_msg = f"–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞: {str(e)}"
            self.trading_log.add_log(error_msg, "error")
            QMessageBox.critical(self, "–û—à–∏–±–∫–∞", error_msg)
    
    def stop_trading_bot(self):
        """–û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–æ—Ä–≥–æ–≤–æ–≥–æ –±–æ—Ç–∞"""
        try:
            if self.bot_worker and self.bot_worker.isRunning():
                # –ü–ª–∞–≤–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞
                self.bot_worker.stop()
                if not self.bot_worker.wait(3000):  # –ñ–¥–µ–º 3 —Å–µ–∫—É–Ω–¥—ã
                    # –ï—Å–ª–∏ –ø–æ—Ç–æ–∫ –Ω–µ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≤–µ—Ä—à–∞–µ–º
                    self.bot_worker.terminate()
                    self.bot_worker.wait()
                self.bot_worker = None
                
            self.start_bot_btn.setEnabled(True)
            self.stop_bot_btn.setEnabled(False)
            self.status_indicator.setText("üî¥ –°–ò–°–¢–ï–ú–ê –û–°–¢–ê–ù–û–í–õ–ï–ù–ê")
            self.status_indicator.setObjectName("status-offline")
            self.status_indicator.style().unpolish(self.status_indicator)
            self.status_indicator.style().polish(self.status_indicator)
            
            self.dashboard_tab.set_bot_running(False)
            self.show_demo_data()
            
            self.trading_log.add_log("–¢–æ—Ä–≥–æ–≤—ã–π –±–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω", "warning")
            
        except Exception as e:
            error_msg = f"–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–æ—Ç–∞: {str(e)}"
            self.trading_log.add_log(error_msg, "error")
    
    def on_bot_status_update(self, message):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –±–æ—Ç–∞"""
        self.bot_status_text.setText(message)
        self.trading_log.add_log(message)
    
    def on_bot_error(self, error_message):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –±–æ—Ç–∞"""
        self.trading_log.add_log(error_message, "error")
    
    def on_account_update(self, account_info):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å—á–µ—Ç–µ"""
        try:
            real_data = {
                'total_balance': account_info.get('total_balance', 0),
                'available_balance': account_info.get('available_balance', 0),
                'unrealized_pnl': account_info.get('unrealized_pnl', 0),
                'positions_count': account_info.get('positions_count', 0),
                'orders_count': account_info.get('orders_count', 0),
                'daily_trades': "0/5",
                'total_trades': account_info.get('total_trades', 0),
                'next_analysis': "2 –º–∏–Ω",
                'performance': account_info.get('unrealized_pnl', 0) / max(account_info.get('total_balance', 1), 1) * 100
            }
            self.dashboard_tab.update_dashboard_data(real_data)
            
            if account_info.get('total_balance', 0) > 0:
                self.connection_status.setText("üîó –ë–∏—Ä–∂–∞: –ü–æ–¥–∫–ª—é—á–µ–Ω–æ")
                self.connection_status.setStyleSheet("color: #00D4AA; font-weight: 600; font-size: 14px;")
                
        except Exception as e:
            print(f"Account update error: {e}")
    
    def on_positions_update(self, positions):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–π"""
        try:
            self.positions_table.update_positions(positions)
            profitable_positions = sum(1 for p in positions if p.get('unrealized_pnl', 0) > 0)
            self.stats_success_label.setText(str(profitable_positions))
            
        except Exception as e:
            print(f"Positions update error: {e}")
    
    def on_analysis_step(self, symbol, step, status, details):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ —à–∞–≥–∞ –∞–Ω–∞–ª–∏–∑–∞"""
        self.analysis_visualizer.add_analysis_step(symbol, step, status, details)
        
        if "–ê–Ω–∞–ª–∏–∑ #" in details and "–∑–∞–≤–µ—Ä—à–µ–Ω" in details:
            self.analysis_count += 1
            self.stats_analysis_label.setText(str(self.analysis_count))
    
    def on_grok_analysis_result(self, symbol, analysis_data):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞ Grok"""
        self.grok_analysis_widget.update_analysis(symbol, analysis_data)
        
        trend = analysis_data.get('trend', 'NEUTRAL')
        confidence = analysis_data.get('confidence', 0) * 100
        self.trading_log.add_log(f"Grok –∞–Ω–∞–ª–∏–∑ {symbol}: {trend} ({confidence:.1f}%)", "info")
    
    def on_technical_analysis_result(self, symbol, technical_data, grok_data, decision):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ —Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º —Ñ–∏–ª—å—Ç—Ä–æ–≤"""
        self.technical_analysis_widget.update_analysis(symbol, technical_data, grok_data, decision)
        
        self.filter_analysis_widget.update_filter_analysis(
            symbol, technical_data, grok_data, decision
        )
    
    def show_demo_data(self):
        """–ü–æ–∫–∞–∑ –¥–µ–º–æ-–¥–∞–Ω–Ω—ã—Ö –∫–æ–≥–¥–∞ –±–æ—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω"""
        demo_data = {
            'total_balance': 0.0,
            'available_balance': 0.0,
            'unrealized_pnl': 0.0,
            'positions_count': 0,
            'orders_count': 0,
            'daily_trades': "0/0",
            'total_trades': 0,
            'next_analysis': "---",
            'performance': 0.0
        }
        self.dashboard_tab.update_dashboard_data(demo_data)
        self.positions_table.setRowCount(0)
    
    def show_settings(self):
        """–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Ç–æ—Ä–≥–æ–≤–ª–∏"""
        self.tabs.setCurrentIndex(2)
        
    def update_ui(self):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞"""
        try:
            current_time = QDateTime.currentDateTime().toString("dd.MM.yyyy ‚Ä¢ hh:mm:ss")
            self.update_time_label.setText(f"üïí {current_time}")
            
        except Exception as e:
            print(f"UI update error: {e}")
    
    def closeEvent(self, event):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–∫—Ä—ã—Ç–∏—è –æ–∫–Ω–∞"""
        try:
            if self.bot_worker and self.bot_worker.isRunning():
                reply = QMessageBox.question(
                    self, 
                    "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ", 
                    "–¢–æ—Ä–≥–æ–≤—ã–π –±–æ—Ç –≤—Å–µ –µ—â–µ —Ä–∞–±–æ—Ç–∞–µ—Ç. –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?",
                    QMessageBox.Yes | QMessageBox.No,
                    QMessageBox.No
                )
                
                if reply == QMessageBox.Yes:
                    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–æ—Ç–∞ –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º
                    self.stop_trading_bot()
                    event.accept()
                else:
                    event.ignore()
            else:
                # –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º —á—Ç–æ –ø–æ—Ç–æ–∫ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
                if self.bot_worker:
                    self.bot_worker.stop()
                event.accept()
        except Exception as e:
            # –í –ª—é–±–æ–º —Å–ª—É—á–∞–µ –ø—ã—Ç–∞–µ–º—Å—è –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ—Ç–æ–∫
            if self.bot_worker:
                self.bot_worker.stop()
            event.accept()

if __name__ == "__main__":
    from PyQt5.QtWidgets import QApplication
    import sys
    
    try:
        app = QApplication(sys.argv)
        
        app.setStyleSheet("""
            QMainWindow {
                background: qlineargradient(x1:0, y1:0, x2:1, y2:1,
                                          stop:0 #0F2027, stop:0.5 #203A43, stop:1 #2C5364);
            }
            
            #glass-card {
                background: rgba(255, 255, 255, 0.08);
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 15px;
                padding: 20px;
            }
            
            QPushButton {
                background: rgba(86, 171, 255, 0.15);
                color: #56ABFF;
                border: 2px solid rgba(86, 171, 255, 0.3);
                border-radius: 10px;
                padding: 12px 18px;
                font-weight: 700;
                font-size: 14px;
            }
            
            QPushButton:hover {
                background: rgba(86, 171, 255, 0.25);
                border: 2px solid rgba(86, 171, 255, 0.5);
            }
            
            QPushButton#success {
                background: rgba(0, 212, 170, 0.15);
                color: #00D4AA;
                border: 2px solid rgba(0, 212, 170, 0.3);
            }
            
            QPushButton#success:hover {
                background: rgba(0, 212, 170, 0.25);
                border: 2px solid rgba(0, 212, 170, 0.5);
            }
            
            QPushButton#danger {
                background: rgba(255, 107, 107, 0.15);
                color: #FF6B6B;
                border: 2px solid rgba(255, 107, 107, 0.3);
            }
            
            QPushButton#danger:hover {
                background: rgba(255, 107, 107, 0.25);
                border: 2px solid rgba(255, 107, 107, 0.5);
            }
            
            QPushButton#secondary {
                background: rgba(176, 176, 176, 0.1);
                color: #B0B0B0;
                border: 2px solid rgba(176, 176, 176, 0.2);
            }
            
            QPushButton#secondary:hover {
                background: rgba(176, 176, 176, 0.2);
                border: 2px solid rgba(176, 176, 176, 0.3);
            }
            
            #header-main {
                color: #FFFFFF;
                font-weight: 700;
                font-size: 28px;
            }
            
            #header-sub {
                color: #B0B0B0;
                font-weight: 500;
                font-size: 14px;
            }
            
            #status-online {
                color: #00D4AA;
                font-weight: 700;
                font-size: 16px;
            }
            
            #status-offline {
                color: #FF6B6B;
                font-weight: 700;
                font-size: 16px;
            }
        """)
        
        window = PremiumMainWindow()
        window.show()
        window.show_demo_data()
        
        sys.exit(app.exec_())
        
    except Exception as e:
        print(f"Application error: {e}")
        QMessageBox.critical(None, "Fatal Error", f"Application failed to start: {str(e)}")
